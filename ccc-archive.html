<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XQ7B0Z9FK3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-XQ7B0Z9FK3');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCC Archive - Chess Nerd</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .ccc-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .ccc-table th,
        .ccc-table td {
            padding: 0.85rem 1rem;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
        }

        .ccc-table th {
            text-transform: uppercase;
            letter-spacing: 0.4px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: var(--bg-secondary);
        }

        .ccc-table tr:last-child td {
            border-bottom: none;
        }

        .ccc-table tbody tr:hover {
            background: var(--bg-secondary);
        }

        .event-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .file-name {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.15rem;
        }

        .date-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            padding: 0.25rem 0.55rem;
            border-radius: 999px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            font-size: 0.85rem;
            white-space: nowrap;
        }

        /* Center Start/End columns (header + cells) */
        .ccc-table th.col-date,
        .ccc-table td.col-date {
            text-align: center;
        }

        .table-note {
            margin-top: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .ccc-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        .ccc-page-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .ccc-page-size {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .ccc-page-size select {
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--bg-input, var(--bg-primary));
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <a href="index.html" style="color: inherit; text-decoration: none;">
                    <span>Chess Nerd</span>
                </a>
            </div>
            <nav class="site-network" aria-label="Network sites">
                <a href="https://text-utils.net" class="site-network-link">
                    Go to Text Utilities
                </a>
            </nav>
            <div class="controls">
                <div class="accent-selector">
                    <span class="material-icons">palette</span>
                    <select id="accentColor" class="color-dropdown"></select>
                </div>
                <button id="themeToggle" class="btn btn-secondary">
                    <span class="material-icons">dark_mode</span>
                </button>
            </div>
        </header>

        <main>
            <div id="toolView">
                <div class="tool-header">
                    <div class="tool-title">
                        <span class="material-icons" id="toolIcon">folder_zip</span>
                        <h2 id="toolName">CCC Archive</h2>
                    </div>
                    <div class="tool-actions">
                        <button id="backButton" class="btn btn-secondary">
                            <span class="material-icons">arrow_back</span>
                            Back
                        </button>
                    </div>
                </div>

                <div class="io-container" style="display: block;">
                    <div class="io-panel" style="width: 100%">
                        <div class="io-label">
                            <span>Computer Chess Championship files</span>
                            <span class="stats" id="cccCount">Loading...</span>
                        </div>

                        <div class="search-box">
                            <input type="text" id="cccSearch" placeholder="Filter by event or filename..." aria-label="Search CCC archive">
                        </div>

                        <div style="background: var(--bg-tertiary); border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color);">
                            <div style="overflow-x: auto;">
                                <table class="ccc-table">
                                    <thead>
                                        <tr>
                                            <th>Event</th>
                                            <th class="col-date">Start</th>
                                            <th class="col-date">End</th>
                                            <th style="text-align: center;">Games</th>
                                            <th style="text-align: right;">Download</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cccTableBody">
                                        <tr>
                                            <td colspan="5">Loading CCC archive...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="ccc-pagination">
                            <div class="ccc-page-size">
                                <label for="cccPageSize">Rows per page:</label>
                                <select id="cccPageSize">
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100" selected>100</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <button id="cccPrevPage" type="button" class="btn btn-secondary">
                                    <span class="material-icons" style="font-size: 1rem; vertical-align: middle; margin-right: 2px;">chevron_left</span>
                                    Previous
                                </button>
                                <span id="cccPageInfo" class="ccc-page-info">Page 1 of 1</span>
                                <button id="cccNextPage" type="button" class="btn btn-secondary">
                                    Next
                                    <span class="material-icons" style="font-size: 1rem; vertical-align: middle; margin-left: 2px;">chevron_right</span>
                                </button>
                            </div>
                        </div>
                        <div class="table-note">
                            Built automatically from <code>ccc_links.txt</code>, <code>events.txt</code>, and <code>game_counts.txt</code> (ccc-archive repo). Files stay in the order provided.
                        </div>
                    </div>
                </div>

                <div class="status-bar">
                    <div id="statusMessage" class="success">Loading CCC archive...</div>
                </div>
            </div>
        </main>

        <footer class="site-footer">
            <p>&copy; Ian Rastall 2025<br>Contact: moving.form.of.dust@gmail.com<br>Donate: PayPal to merastall@gmail.com</p>
        </footer>
    </div>

    <script src="js/theme.js"></script>
    <script>
        document.getElementById('backButton').addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        const cccTableBody = document.getElementById('cccTableBody');
        const cccCount = document.getElementById('cccCount');
        const searchInput = document.getElementById('cccSearch');
        const statusMessage = document.getElementById('statusMessage');
        const prevBtnPage = document.getElementById('cccPrevPage');
        const nextBtnPage = document.getElementById('cccNextPage');
        const pageInfoEl = document.getElementById('cccPageInfo');
        const pageSizeSelect = document.getElementById('cccPageSize');

        let allEntries = [];
        let filteredEntries = [];
        let currentPage = 1;
        let rowsPerPage = 100;

        // CCC uses 6-digit YYMMDD codes in filenames.
        // Display format: 20YY-MM-DD
        function toIsoDate(code) {
            if (!code) return '';
            const s = String(code).trim();

            if (s.length === 6 && /^\d{6}$/.test(s)) {
                const yy = s.slice(0, 2);
                const mm = s.slice(2, 4);
                const dd = s.slice(4, 6);
                return `20${yy}-${mm}-${dd}`;
            }

            // Safe fallback (should not happen in your current workflow)
            return s;
        }

        function buildEventMap(text) {
            const map = {};
            text.split(/\r?\n/).forEach(line => {
                if (!line.trim()) return;
                const separatorIndex = line.indexOf(':');
                if (separatorIndex === -1) return;
                const filePart = line.slice(0, separatorIndex).trim();
                const eventName = line.slice(separatorIndex + 1).trim();
                if (!filePart || !eventName) return;
                const base = filePart.replace('.pgn', '');
                map[base] = eventName;
            });
            return map;
        }

        function buildGameCountMap(text) {
            const map = {};
            text.split(/\r?\n/).forEach(line => {
                if (!line.trim()) return;
                const separatorIndex = line.indexOf(':');
                if (separatorIndex === -1) return;
                const filePart = line.slice(0, separatorIndex).trim();
                const trailing = line.slice(separatorIndex + 1).trim();
                const numString = trailing.split(/\s+/)[0];
                const num = parseInt(numString, 10);
                if (!filePart || Number.isNaN(num)) return;
                const base = filePart.replace('.pgn', '');
                map[base] = num;
            });
            return map;
        }

        function buildEntries(linksText, eventsMap, gameCountsMap) {
            return linksText
                .split(/\r?\n/)
                .filter(Boolean)
                .map(url => {
                    const fileName = url.split('/').pop();
                    const base = fileName.replace('.zip', '');
                    const parts = base.split('-');
                    const startCode = parts[0] || '';
                    const endCode = parts[1] || '';

                    const eventName = eventsMap[base] || base;
                    const games = gameCountsMap && Object.prototype.hasOwnProperty.call(gameCountsMap, base)
                        ? gameCountsMap[base]
                        : null;

                    return {
                        eventName,
                        startDate: toIsoDate(startCode),
                        endDate: toIsoDate(endCode),
                        url,
                        fileName,
                        games,
                        eventLower: eventName.toLowerCase(),
                        fileLower: fileName.toLowerCase()
                    };
                });
        }

        function formatNumber(val) {
            if (val === null || val === undefined) return '—';
            const num = Number(val);
            if (Number.isNaN(num)) return '—';
            return num.toLocaleString();
        }

        function renderPage() {
            const total = filteredEntries.length;
            const totalPages = Math.max(1, Math.ceil(total / rowsPerPage));
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            if (!total) {
                cccTableBody.innerHTML = '<tr><td colspan="5">No matching events.</td></tr>';
                cccCount.textContent = '0 files';
            } else {
                const startIndex = (currentPage - 1) * rowsPerPage;
                const visible = filteredEntries.slice(startIndex, startIndex + rowsPerPage);

                cccTableBody.innerHTML = visible.map(entry => `
                    <tr>
                        <td>
                            <div class="event-name">${entry.eventName}</div>
                            <div class="file-name">${entry.fileName}</div>
                        </td>
                        <td class="col-date"><span class="date-chip">${entry.startDate}</span></td>
                        <td class="col-date"><span class="date-chip">${entry.endDate}</span></td>
                        <td style="text-align: center;">${formatNumber(entry.games)}</td>
                        <td style="text-align: right;">
                            <a href="${entry.url}" class="btn btn-primary btn-sm" target="_blank" rel="noopener">
                                <span class="material-icons" style="font-size: 1.05em; vertical-align: text-bottom; margin-right: 4px;">cloud_download</span>ZIP
                            </a>
                        </td>
                    </tr>
                `).join('');

                const label = total === 1 ? 'file' : 'files';
                cccCount.textContent = `${total} ${label}`;
            }

            const pages = Math.max(1, Math.ceil(total / rowsPerPage));
            if (pageInfoEl) {
                if (total === 0) {
                    pageInfoEl.textContent = 'No matching pages';
                } else {
                    pageInfoEl.textContent = `Page ${currentPage} of ${pages} (${total} shown)`;
                }
            }

            if (prevBtnPage) prevBtnPage.disabled = currentPage <= 1 || filteredEntries.length === 0;
            if (nextBtnPage) nextBtnPage.disabled = currentPage >= pages || filteredEntries.length === 0;
        }

        function applyFilter(query) {
            const q = query ? query.toLowerCase() : '';
            filteredEntries = allEntries.filter(entry =>
                !q || entry.eventLower.includes(q) || entry.fileLower.includes(q)
            );
            currentPage = 1;
            renderPage();
        }

        async function loadCCCArchive() {
            try {
                statusMessage.textContent = 'Loading CCC archive...';
                const [linksRes, eventsRes, countsRes] = await Promise.all([
                    fetch('ccc_links.txt'),
                    fetch('events.txt'),
                    fetch('game_counts.txt')
                ]);

                if (!linksRes.ok || !eventsRes.ok || !countsRes.ok) {
                    throw new Error('Unable to load CCC lists.');
                }

                const [linksText, eventsText, countsText] = await Promise.all([
                    linksRes.text(),
                    eventsRes.text(),
                    countsRes.text()
                ]);

                const eventsMap = buildEventMap(eventsText);
                const gameCountsMap = buildGameCountMap(countsText);
                allEntries = buildEntries(linksText, eventsMap, gameCountsMap);
                filteredEntries = allEntries.slice();
                renderPage();
                statusMessage.textContent = 'Ready';
            } catch (err) {
                console.error(err);
                statusMessage.textContent = 'Error loading CCC archive';
                cccTableBody.innerHTML = `<tr><td colspan="5">${err.message}</td></tr>`;
            }
        }

        if (searchInput) {
            searchInput.addEventListener('input', (e) => applyFilter(e.target.value));
        }

        if (pageSizeSelect) {
            pageSizeSelect.addEventListener('change', () => {
                const val = parseInt(pageSizeSelect.value, 10);
                rowsPerPage = Number.isNaN(val) ? 100 : val;
                currentPage = 1;
                renderPage();
            });
        }

        if (prevBtnPage) {
            prevBtnPage.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage -= 1;
                    renderPage();
                }
            });
        }

        if (nextBtnPage) {
            nextBtnPage.addEventListener('click', () => {
                const pages = Math.max(1, Math.ceil(filteredEntries.length / rowsPerPage));
                if (currentPage < pages) {
                    currentPage += 1;
                    renderPage();
                }
            });
        }

        loadCCCArchive();
    </script>
</body>
</html>
