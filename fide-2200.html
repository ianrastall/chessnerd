<!-- fide-2200.html -->
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIDE Standard 2200+ - Chess Nerd</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XQ7B0Z9FK3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XQ7B0Z9FK3');
    </script>

    <style>
        /* Minimal page-specific styling. Keeps your site’s global style.css intact. */
        .tool-header .tool-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .filters-panel {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--panel-bg);
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: end;
        }

        .input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 200px;
            flex: 1 1 220px;
        }

        .filters-footer {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
        }

        .results-count {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .copy-btn {
            white-space: nowrap;
        }

        table.std-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        table.std-table th, table.std-table td {
            padding: 10px 10px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            vertical-align: top;
        }

        table.std-table th {
            font-weight: 600;
            color: var(--text);
            background: var(--panel-bg);
        }

        tr:hover td {
            background: rgba(255,255,255,0.03);
        }

        .rating-cell {
            font-weight: 700;
        }

        .title-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid var(--border-color);
            font-size: 0.8rem;
            line-height: 1.2;
        }

        .gm-title {
            border-color: rgba(255, 215, 0, 0.35);
        }
        .im-title {
            border-color: rgba(135, 206, 250, 0.35);
        }

        .hide-mobile {
            display: table-cell;
        }

        @media (max-width: 800px) {
            .hide-mobile {
                display: none;
            }
        }

        #loadMoreArea {
            margin-top: 12px;
            display: none;
            text-align: center;
        }
    </style>
</head>

<body>
    <header class="site-header">
        <div class="brand">
            <a href="index.html" class="brand-link">
                <span class="material-icons">extension</span>
                <span>Chess Nerd</span>
            </a>
        </div>
        <div class="controls">
            <div class="accent-selector">
                <span class="material-icons">palette</span>
                <select id="accentColor" class="color-dropdown">
                    <option value="#deb887">Burlywood</option>
                    <option value="#5f9ea0">Cadet Blue</option>
                    <option value="#6495ed">Cornflower</option>
                    <option value="#0d9488">Teal</option>
                    <option value="#8b5cf6">Purple</option>
                    <option value="#ef4444">Red</option>
                </select>
            </div>
            <button id="themeToggle" class="btn btn-secondary">
                <span class="material-icons">dark_mode</span>
            </button>
        </div>
    </header>

    <main>
        <div id="toolView">
            <div class="tool-header">
                <div class="tool-title">
                    <span class="material-icons" id="toolIcon">groups</span>
                    <div>
                        <h2 id="toolName" style="margin-bottom: 0;">FIDE Standard 2200+ Players</h2>
                        <div style="color: var(--text-secondary); font-size: 0.85rem; font-weight: normal; margin-top: 2px;">
                            FIDE-rated players with Standard rating &ge; 2200 (peak standard rating from monthly FIDE lists)
                        </div>
                    </div>
                </div>
                <div class="tool-actions">
                    <button id="backButton" class="btn btn-secondary">
                        <span class="material-icons">arrow_back</span>
                        Back
                    </button>
                </div>
            </div>

            <div class="io-container" style="display: block;">
                <div class="io-panel" style="width: 100%;">
                    <div class="filters-panel">
                        <!-- Single row: Min Elo, Federation, Search -->
                        <div class="filter-row">
                            <div class="input-wrapper">
                                <label>Min Elo (floor 2200):</label>
                                <input
                                    type="number"
                                    id="minElo"
                                    class="std-input"
                                    value="2200"
                                    step="50"
                                    min="2200"
                                >
                            </div>
                            <div class="input-wrapper">
                                <label>Federation (3-letter):</label>
                                <input
                                    type="text"
                                    id="countryFilter"
                                    class="std-input"
                                    placeholder="e.g., USA"
                                    maxlength="3"
                                >
                            </div>
                            <div class="input-wrapper" style="flex: 2 1 320px;">
                                <label>Search (name or FIDE ID):</label>
                                <input
                                    type="text"
                                    id="searchFilter"
                                    class="std-input"
                                    placeholder="e.g., Carlsen / 1503014"
                                >
                            </div>
                        </div>

                        <div class="filter-row filters-footer">
                            <div class="results-count" id="countDisplay">Loading database...</div>
                            <button id="copyBtn" class="btn btn-secondary copy-btn">
                                <span class="material-icons" style="font-size: 1.1rem;">content_copy</span>
                                Copy list
                            </button>
                        </div>
                    </div>

                    <table class="std-table">
                        <thead>
                            <tr>
                                <th style="width: 38%;">Player</th>
                                <th style="width: 16%;">Title(s)</th>
                                <th style="width: 10%;">FED</th>
                                <th id="ratingHeader" style="width: 12%;">Standard</th>
                                <th class="hide-mobile" style="width: 10%;">Year</th>
                                <th style="width: 14%; text-align: right;">Profile</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- rows injected here -->
                        </tbody>
                    </table>

                    <div id="loadMoreArea">
                        <button id="loadMoreBtn" class="btn btn-secondary">
                            Load more
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/theme.js"></script>
    <script>
        // ---- Data + paging ----
        let allPlayers = [];
        let filteredPlayers = [];
        const BATCH_SIZE = 200;
        let displayLimit = 100;

        // Minimum allowed threshold
        const MIN_ELO_FLOOR = 2200;

        // ---- Navigation ----
        document.getElementById('backButton').addEventListener('click', () => {
            // Adjust if your site uses a different navigation pattern
            window.location.href = 'index.html';
        });

        // ---- Load JSON ----
        async function loadData() {
            try {
                const res = await fetch('fide-2200.json', { cache: 'no-store' });
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status} when fetching fide-2200.json`);
                }
                const data = await res.json();

                if (!Array.isArray(data)) {
                    throw new Error('JSON is not an array of players.');
                }

                allPlayers = data;

                // initial view
                applyFilters();
            } catch (err) {
                console.error(err);
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = `<tr><td colspan="6" style="padding: 12px; color: var(--danger, #ef4444);">
                    Failed to load fide-2200.json: ${escapeHtml(err.message)}
                </td></tr>`;
                document.getElementById('countDisplay').textContent = 'Error loading database.';
            }
        }

        // ---- Filtering helpers ----
        function getCurrentMinElo() {
            const input = document.getElementById('minElo');
            let val = parseInt(input.value || '0', 10) || 0;
            if (val < MIN_ELO_FLOOR) {
                val = MIN_ELO_FLOOR;
            }
            input.value = val;
            return val;
        }

        function applyFilters() {
            // reset pagination
            displayLimit = 100;

            const minElo = getCurrentMinElo();
            const countryFilter = (document.getElementById('countryFilter').value || '').trim().toUpperCase();
            const searchTermRaw = (document.getElementById('searchFilter').value || '').trim();
            const searchTerm = searchTermRaw.toLowerCase();

            filteredPlayers = allPlayers.filter(p => {
                const std = p.std || 0;

                // Rating filter (Standard only)
                if (std < minElo) return false;

                // Federation filter (3-letter code)
                if (countryFilter) {
                    if (!p.country || String(p.country).toUpperCase() !== countryFilter) {
                        return false;
                    }
                }

                // Search filter (name / FIDE ID)
                if (searchTerm) {
                    const name = (p.name || '').toLowerCase();
                    const fideid = String(p.fideid || '');
                    if (!name.includes(searchTerm) && !fideid.includes(searchTermRaw)) {
                        return false;
                    }
                }

                return true;
            });

            // Sort by standard (desc), then name
            filteredPlayers.sort((a, b) => {
                const rA = a.std || 0;
                const rB = b.std || 0;
                if (rB !== rA) return rB - rA;

                const nameA = (a.name || '').toUpperCase();
                const nameB = (b.name || '').toUpperCase();
                if (nameA < nameB) return -1;
                if (nameA > nameB) return 1;
                return 0;
            });

            updateCountDisplay();
            renderTable();
        }

        function updateCountDisplay() {
            const countDisplay = document.getElementById('countDisplay');
            const minElo = getCurrentMinElo();

            if (!filteredPlayers.length) {
                countDisplay.textContent = 'No players match the current filters.';
                return;
            }

            countDisplay.textContent = `${filteredPlayers.length.toLocaleString()} players ( Standard ≥ ${minElo} )`;
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const toShow = filteredPlayers.slice(0, displayLimit);

            toShow.forEach(p => {
                const tr = document.createElement('tr');

                const displayTitlePieces = [];
                if (p.title) displayTitlePieces.push(p.title);
                if (p.w_title) displayTitlePieces.push(p.w_title);
                const displayTitle = displayTitlePieces.join(' / ');

                let titleClass = 'title-badge';
                const primaryTitle = (p.title || p.w_title || '').toUpperCase();
                if (primaryTitle.includes('GM')) titleClass += ' gm-title';
                else if (primaryTitle.includes('IM')) titleClass += ' im-title';

                const ratingValue = p.std || 0;
                const ratingText = ratingValue > 0 ? ratingValue : '-';
                const yearText = p.year || '';

                const profileUrl = `https://ratings.fide.com/profile/${p.fideid}`;

                tr.innerHTML = `
                    <td>
                        <div style="font-weight:500;">${escapeHtml(p.name || '(No name)')}</div>
                        <div class="hide-mobile" style="font-size:0.8rem; color:var(--text-secondary);">
                            FIDE ID: ${escapeHtml(String(p.fideid || ''))}
                        </div>
                    </td>
                    <td>
                        ${displayTitle ? `<span class="${titleClass}">${escapeHtml(displayTitle)}</span>` : ''}
                    </td>
                    <td>${escapeHtml(p.country || '')}</td>
                    <td class="rating-cell" style="color: var(--accent);">
                        ${ratingText}
                    </td>
                    <td class="hide-mobile">${yearText ? escapeHtml(String(yearText)) : ''}</td>
                    <td style="text-align: right;">
                        <a href="${profileUrl}" target="_blank" rel="noopener" class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.8rem;">
                            View
                        </a>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            const loadMoreArea = document.getElementById('loadMoreArea');
            if (filteredPlayers.length > displayLimit) {
                loadMoreArea.style.display = 'block';
            } else {
                loadMoreArea.style.display = 'none';
            }
        }

        function copyListToClipboard() {
            if (!filteredPlayers.length) {
                return;
            }
            const ratingLabel = 'Standard';

            const lines = [];
            lines.push(['Name', 'Title(s)', 'Federation', ratingLabel, 'Year', 'FIDE ID'].join('\t'));

            filteredPlayers.forEach(p => {
                const titlePieces = [];
                if (p.title) titlePieces.push(p.title);
                if (p.w_title) titlePieces.push(p.w_title);
                const titleStr = titlePieces.join(' / ');

                const ratingValue = p.std || 0;
                const ratingText = ratingValue > 0 ? ratingValue : '';

                lines.push([
                    p.name || '',
                    titleStr,
                    p.country || '',
                    ratingText,
                    p.year || '',
                    p.fideid || ''
                ].join('\t'));
            });

            const text = lines.join('\n');

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(showCopySuccess)
                    .catch(err => console.error('Clipboard copy failed:', err));
            } else {
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                try { document.execCommand('copy'); } catch (e) { console.error(e); }
                document.body.removeChild(ta);
                showCopySuccess();
            }
        }

        function showCopySuccess() {
            const btn = document.getElementById('copyBtn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<span class="material-icons" style="font-size: 1.1rem;">check</span> Copied!`;
            setTimeout(() => {
                btn.innerHTML = originalHTML;
            }, 2000);
        }

        // Utility: simple HTML escape
        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Event Listeners
        document.getElementById('minElo').addEventListener('input', debounce(applyFilters, 300));
        document.getElementById('countryFilter').addEventListener('input', debounce(applyFilters, 300));
        document.getElementById('searchFilter').addEventListener('input', debounce(applyFilters, 300));
        document.getElementById('loadMoreBtn').addEventListener('click', () => {
            displayLimit += BATCH_SIZE;
            renderTable();
        });
        document.getElementById('copyBtn').addEventListener('click', () => copyListToClipboard());

        // Kick off
        loadData();
    </script>
</body>
</html>
